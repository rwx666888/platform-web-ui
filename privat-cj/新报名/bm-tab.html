<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>优惠类型</title>
    <link rel="stylesheet" href="../../css/animate.min.css" />
    <link rel="stylesheet" href="../../css/iconfont.css" />
    <link rel="stylesheet" href="../../font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../../css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../css/plugins/iCheck/custom.css" />

    <link rel="stylesheet" href="../../css/style.css" />
    <style>
      .cus-tabmodel-default {
        padding-right: 70px;
      }

      .btn-box-info {
        z-index: 20;
        top: 0;
      }

      .choice-content {
        /* padding-top: 40px; */
      }
    </style>
  </head>

  <body>
    <div id="eventMain" class="container-fluid">
      <div class="row p-sm">
        <div class="col-sm-8">
          <!-- tab btn -->
          <div class="btn-box-info">
            <button id="discountType" class="btn btn-success btn-sm" type="button">确定</button>
          </div>
          <!-- tab header -->
          <div class="cus-tabmodel-box cus-tabmodel-default">
            <div id="tab_list_box" class="tab-list-box">
              <!-- btn left -->
              <button class="roll-nav roll-left tab-roll-btn tab-left-btn btn-default">
                <i class="glyphicon glyphicon-backward"></i>
              </button>
              <!-- content -->
              <div class="tab-list-overflow">
                <div class="tab-list-bar">
                  <ul class="nav nav-tabs tab-list-ul pull-left" role="tablist" id="tabHeader"></ul>
                </div>
              </div>
              <!-- btn right -->
              <button class="roll-nav roll-right tab-roll-btn tab-right-btn btn-default">
                <i class="glyphicon glyphicon-forward"></i>
              </button>
            </div>
          </div>
          <!-- tab body -->
          <div id="tabContent" class="tab-content"></div>
        </div>
        <!-- choice content -->
        <div class="col-sm-4 choice-content">
          <h3>已选优惠</h3>
          <table class="table table-striped table-bordered nowrap" cellspacing="0" width="100%">
            <thead>
              <tr>
                <th>类型</th>
                <th>名称</th>
                <th>金额</th>
              </tr>
            </thead>
            <tbody id="choiceContent"></tbody>
          </table>
          <!-- 合计 -->
          <div class="form-inline sum-price">
            <div class="form-group pull-right">
              <label class="pull-left">合计：</label
              ><input type="text" class="form-control input-sm js-money" id="sumPrice" readonly />
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="../../js/jquery-2.1.1.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../i18n/zh-CN.js"></script>

    <script src="../../js/plugins/jquery-number/jquery.number.min.js"></script>
    <script src="../../js/plugins/iCheck/icheck.min.js"></script>
    <script src="../../js/plugins/layer/layer3.1.1.js"></script>

    <script src="../../js/subindex.js"></script>

    <script src="../../js/jquery.mockjax.min.js"></script>
    <script>
      $.mockjax({
        url: '/discountClassify/listClassifyAndDiscount',
        responseText: [
          {
            code: 'KYYH',
            name: '开业优惠',
            list: [
              {
                code: '01',
                name: '开业优惠01',
                preferentialWayName: '开业优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              },
              {
                code: '02',
                name: '开业优惠02',
                preferentialWayName: '开业优惠02',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              },
              {
                code: '03',
                name: '开业优惠03',
                preferentialWayName: '开业优惠03',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'BMYH',
            name: '报名优惠',
            list: [
              {
                code: '01',
                name: '报名优惠01',
                preferentialWayName: '报名优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'YBYH',
            name: '一般优惠',
            list: [
              {
                code: '01',
                name: '一般优惠01',
                preferentialWayName: '一般优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'QDYQYH',
            name: '前端疫情优惠',
            list: [
              {
                code: '01',
                name: '前端疫情优惠01',
                preferentialWayName: '前端疫情优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'YQYH',
            name: '后端疫情优惠',
            list: [
              {
                code: '01',
                name: '后端疫情优惠01',
                preferentialWayName: '后端疫情优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'XGHDYH',
            name: '后端优惠',
            list: [
              {
                code: '01',
                name: '后端优惠01',
                preferentialWayName: '后端优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'XFYH',
            name: '续费优惠',
            list: [
              {
                code: '01',
                name: '续费优惠01',
                preferentialWayName: '续费优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'KKYH',
            name: '扩科优惠',
            list: [
              {
                code: '01',
                name: '扩科优惠01',
                preferentialWayName: '扩科优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'BMZZYH',
            name: '周中优惠',
            list: [
              {
                code: '01',
                name: '周中优惠01',
                preferentialWayName: '周中优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'HDYH',
            name: '活动优惠',
            list: [
              {
                code: '01',
                name: '活动优惠01',
                preferentialWayName: '活动优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          },
          {
            code: 'TSYH',
            name: '特殊优惠',
            list: [
              {
                code: '01',
                name: '特殊优惠01',
                preferentialWayName: '特殊优惠01',
                discount: '0',
                money: '0',
                classHour: '0',
                classCount: '0'
              }
            ]
          }
        ]
      });

      $.mockjax({
        url: '/newsignup/discount/calculationDiscountAmount',
        responseText: [
          {
            type: 'YBYH1',
            code: '12',
            price: '100'
          },
          {
            type: 'YBYH3',
            code: '31',
            price: '300'
          }
        ]
      });
    </script>
    <script>
      // 存储
      var TMP_RES = '';

      var COM_FN = {
        add: function (arg1, arg2) {
          (arg1 = arg1.toString()), (arg2 = arg2.toString());
          var arg1Arr = arg1.split('.'),
            arg2Arr = arg2.split('.'),
            d1 = arg1Arr.length == 2 ? arg1Arr[1] : '',
            d2 = arg2Arr.length == 2 ? arg2Arr[1] : '';
          var maxLen = Math.max(d1.length, d2.length);
          var m = Math.pow(10, maxLen);
          var result = Number(((arg1 * m + arg2 * m) / m).toFixed(maxLen));
          var d = arguments[2];
          return typeof d === 'number' ? Number(result.toFixed(d)) : result;
        }
      };

      // 处理 history data
      function handleData(params) {
        var obj = {};

        for (var i = 0; i < params.length; i++) {
          var item = params[i];

          obj['t_' + item.typeCode + '_' + item.code] = item;
        }

        return obj;
      }

      // 生成 已选类型
      function choiceDiscountHTML(list) {
        var html = [];
        var sumPrice = 0;

        for (var i = 0; i < list.length; i++) {
          var item = list[i];

          html.push(
            '<tr id="type_' +
              item.typeCode +
              '" data-code="' +
              item.code +
              '"><td>' +
              item.typeName +
              '</td><td>' +
              item.name +
              '</td><td class="js-discount-price">' +
              (item.price || 0) +
              '</td></tr>'
          );

          sumPrice = COM_FN.add(sumPrice, item.price);
        }

        $('#choiceContent').html(html.join(''));
        // 合计展示
        $('#sumPrice').val(sumPrice);
      }

      // 生成 tab
      function checkTSData($obj) {
        var val = $obj.val();
        var ts_val = Number($obj.data('ts'));
        var type = $obj.data('type');

        if (!/^[0-9]+$/.test(val)) {
          return true;
        }

        return val == '' || val == 0 || val > ts_val;
      }

      function tsTrHTML(type, item) {
        var res = {
          res: true,
          html: ''
        };

        if (type == 'YHFS020') {
          // 直减 money
          res.html =
            '<td><input data-type="money" data-ts="' +
            item.money +
            '" class="form-control input-sm js-inp-ts" type="text"></td>' +
            '<td>' +
            item.classHour +
            '</td>' +
            '<td>' +
            item.classCount +
            '</td>';
        } else if (type == 'YHFS060') {
          // 课时 classHour
          res.html =
            '<td>' +
            item.money +
            '</td>' +
            '<td><input data-type="classHour" data-ts="' +
            item.classHour +
            '" class="form-control input-sm js-inp-ts" type="text"></td>' +
            '<td>' +
            item.classCount +
            '</td>';
        } else if (type == 'YHFS070') {
          // 课次 classCount
          res.html =
            '<td>' +
            item.money +
            '</td>' +
            '<td>' +
            item.classHour +
            '</td>' +
            '<td><input data-type="classCount" data-ts="' +
            item.classCount +
            '" class="form-control input-sm js-inp-ts" type="text"></td>';
        } else {
          res.res = false;
        }

        return res;
      }

      function tableTrHTML(list, callback) {
        console.log(callback);

        for (var i = 0; i < list.length; i++) {
          var item = list[i];
          var item_discount = item.list || [];
          var html = [];

          for (var j = 0; j < item_discount.length; j++) {
            var item_j = item_discount[j];
            var ifChecked = false;
            // 是否选中
            if (callback && callback['t_' + item.code + '_' + item_j.code]) {
              ifChecked = true;
            }

            var ts_check = tsTrHTML(item_j.preferentialWay, item_j);
            var tmp_html = '';

            if (ts_check.res) {
              tmp_html = ts_check.html;
            } else {
              tmp_html =
                '<td>' +
                item_j.money +
                '</td>' +
                '<td>' +
                item_j.classHour +
                '</td>' +
                '<td>' +
                item_j.classCount +
                '</td>';
            }
            // console.log(item_j)

            var inputCheck = '';
            if (item.code == 'KYYH') {
              inputCheck =
                '<label class="radio-inline i-checks"><input type="checkbox" class="js-tr-discount" name="r_' +
                item.code +
                '[]" value="' +
                item_j.code +
                '" ' +
                (ifChecked ? 'checked' : '') +
                '></label>';
            } else {
              inputCheck =
                '<label class="checkbox-inline i-checks"><input type="radio" class="js-tr-discount" name="r_' +
                item.code +
                '" value="' +
                item_j.code +
                '" ' +
                (ifChecked ? 'checked' : '') +
                '></label>';
            }

            html.push(
              $(
                '<tr class="js-tr-item" data-type="' +
                  item.code +
                  '" data-name="' +
                  item.name +
                  '">' +
                  '<td>' +
                  inputCheck +
                  '</td>' +
                  '<td>' +
                  item_j.name +
                  '</td>' +
                  '<td>' +
                  item_j.preferentialWayName +
                  '</td>' +
                  '<td>' +
                  item_j.discount +
                  '</td>' +
                  tmp_html +
                  '</tr>'
              ).data('sdata', item_j)
            );
          }
          // console.log(html)
          $('#tab_' + item.code)
            .find('tbody')
            .html(html);
        }
      }

      function tabBodyHTML(idx, key, item) {
        var html = [];

        return (
          '<div role="tabpanel" class="tab-pane ' +
          (idx == 0 ? 'active' : '') +
          '" id="tab_' +
          key +
          '">' +
          '<table class="table table-striped table-bordered nowrap js-table-discount" cellspacing="0" width="100%">' +
          '<thead>' +
          '<tr>' +
          '<th>操作</th>' +
          '<th>优惠名称</th>' +
          '<th>优惠方式</th>' +
          '<th>折扣</th>' +
          '<th>金额</th>' +
          '<th>优惠课时</th>' +
          '<th>优惠课次</th>' +
          '</tr>' +
          '</thead>' +
          '<tbody></tbody>' +
          '</table>' +
          '</div>'
        );
      }

      function tabContentHTML() {
        var head_html = [],
          body_html = [];
        var callback_data = {};

        var params = {
          orderCode: COM_TOOLS.requestParam('orderCode'),
          orderType: COM_TOOLS.requestParam('orderType'),
          informationCode: COM_TOOLS.requestParam('informationCode'),
          informationSource: COM_TOOLS.requestParam('informationSource'),
          informationChannel: COM_TOOLS.requestParam('informationChannel'),
          studentCode: COM_TOOLS.requestParam('studentCode'),
          orgCoreCode: COM_TOOLS.requestParam('orgCoreCode'),
          courseClassificationCode: COM_TOOLS.requestParam('classificationCode'),
          courseCode: COM_TOOLS.requestParam('courseCode'),
          courseStageCode: COM_TOOLS.requestParam('courseStageCode'),
          classHourRatio: COM_TOOLS.requestParam('classHourRatio'),
          mulIndex: false,
          isDisabled: '0',
          weekendType: COM_TOOLS.requestParam('weekendType'),
          discountTermOfMoney: COM_TOOLS.requestParam('discountTermOfMoney'),
          discountTermOfClassHour: COM_TOOLS.requestParam('discountTermOfClassHour'),
          packageType: COM_TOOLS.requestParam('packageType')
        };

        $.get('/discountClassify/listClassifyAndDiscount', params).then(function (res) {
          if (!res.length) {
            COM_TOOLS.alert('无可用优惠');
            return false;
          }
          // 回显数据处理
          if (cum_ModalValobj && cum_ModalValobj.history.length) {
            callback_data = handleData(cum_ModalValobj.history);
            console.log('his-', cum_ModalValobj.history);
            // 数据回显
            choiceDiscountHTML(cum_ModalValobj.history);
          }

          for (var i = 0; i < res.length; i++) {
            var elm = res[i];
            // header
            head_html.push(
              '<li role="presentation" ' +
                (i == 0 ? 'class="active"' : '') +
                '>' +
                '<a href="#tab_' +
                elm.code +
                '" aria-controls="tab' +
                i +
                '" role="tab" data-toggle="tab">' +
                elm.name +
                '</a>' +
                '</li>'
            );
            // body
            body_html.push(tabBodyHTML(i, elm.code, elm));
          }

          $('#tabHeader').html(head_html.join(''));
          $('#tabContent').html(body_html.join(''));
          tableTrHTML(res, callback_data);

          COM_TOOLS._view.tabScrollFn.init('#tab_list_box');

          $('.i-checks').iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green'
          });
        });
      }

      // 获取 所选的 radio
      function getCheckedRadio(type, val) {
        var tmp_arr = [];
        var checked_inp = $('.js-tr-discount:checked');

        // 获取所有勾选的内容
        checked_inp.each(function (key, item) {
          var t_ = $(this);
          var p_tr = t_.closest('.js-tr-item');
          var data = p_tr.data();
          // 合并数据
          data.sdata.typeCode = data.type;
          data.sdata.typeName = data.name;
          // 特殊处理
          if (type) {
            data.sdata[type] = val;
          }

          tmp_arr.push(data.sdata);
        });

        return tmp_arr;
      }

      tabContentHTML();
      // 优惠套餐-前/后端优惠限制 tmpType 信息量跟踪(前) TCLX01｜学员管理(后) TCLX02
      function checkDiscountsLimitByTmp(list, tmpType) {
        function checkMethod01(rule, list) {
          var tmp = [];
          list.forEach(function (item) {
            if (rule.indexOf(item.typeCode) !== -1) {
              tmp.push(item.typeCode);
            }
          });
          return tmp;
        }
        function checkMethod02(rule, list) {
          var tmp = [[], []];
          list.forEach(function (item) {
            if (rule[0].indexOf(item.typeCode) !== -1) {
              tmp[0].push(item.typeCode);
            }
            if (rule[1].indexOf(item.typeCode) !== -1) {
              tmp[1].push(item.typeCode);
            }
          });
          return tmp;
        }
        list = list || [];

        var rule011 = ['BMYH', 'XFYH', 'KKYH'];
        var rule012 = ['XFYH', 'KKYH'];
        var rule021 = [
          ['BMYH', 'QDYQYH'],
          ['YQYH', 'XGHDYH']
        ];

        var flag = false;
        if (list && list.length > 1) {
          if (tmpType === 'TCLX01') {
            var resList = checkMethod01(rule011, list);
            flag = resList.length >= 2;
            // rule021 四种都存在时
            var resList2 = checkMethod02(rule021, list);
            flag = flag || (resList2[0].length >= 1 && resList2[1].length >= 1);
          } else if (tmpType === 'TCLX02') {
            var resList = checkMethod01(rule012, list);
            flag = resList.length >= 2;
          }
        }

        return flag;
      }

      // bind event
      $('#eventMain')
        .on('ifChecked', '.js-tr-discount', function (evt) {
          var t_ = $(this);
          var p_tr = t_.closest('.js-tr-item');
          var ts_inp = p_tr.find('.js-inp-ts');

          if (ts_inp.length) {
            if (checkTSData(ts_inp)) {
              setTimeout(function () {
                t_.iCheck('uncheck');
              }, 100);
              COM_TOOLS.alert('请填写内容，且<=基础值的整数');
              return false;
            }
            ts_inp.prop('disabled', true);
            // 获取所选项
            var tmp_arr = getCheckedRadio(ts_inp.data('type'), ts_inp.val());
          } else {
            var tmp_arr = getCheckedRadio();
          }

          console.log('old--', tmp_arr);
          if (
            checkDiscountsLimitByTmp(tmp_arr, COM_TOOLS.requestParam('packageType') || 'TCLX01')
          ) {
            setTimeout(function () {
              t_.iCheck('uncheck');
            }, 100);
            COM_TOOLS.alert('所选优惠类型相斥');
            return false;
          }

          // 获取所选优惠实际优惠金额 全量数据
          if (cum_ModalValobj != null) {
            cum_ModalValobj['list'] = JSON.stringify(tmp_arr);
            var sumPrice = 0;

            $.post('/newsignup/discount/calculationDiscountAmount', cum_ModalValobj).then(function (
              res
            ) {
              for (var i = 0; i < res.length; i++) {
                var item = res[i];

                for (var j = 0; j < tmp_arr.length; j++) {
                  var item_j = tmp_arr[j];

                  if (item_j.code == item.code) {
                    item_j['price'] = item.price;

                    sumPrice = COM_FN.add(sumPrice, item.price);
                  }
                }
              }
              // 合计展示
              $('#sumPrice').val(sumPrice);
              // 生成 html
              console.log('new--', tmp_arr);
              choiceDiscountHTML(tmp_arr);
              TMP_RES = tmp_arr;
            });
          }
          // console.log(JSON.stringify(cum_ModalValobj));
        })
        .on('click', '#discountType', function () {
          console.log('-btn-', cum_ModalValobj);
          COM_TOOLS.callParentWinCacheFn('fn1', TMP_RES);

          cumParentCallValue();
        })
        .on('click', '#discountClear', function () {
          // empty
          COM_TOOLS.callParentWinCacheFn('empty');

          cumParentCallValue();
        });
    </script>
  </body>
</html>

<!doctype html>
<html>

    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <title>fullCalendar</title>

        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../font-awesome/css/font-awesome.css" rel="stylesheet">

        <!--<link href="../../css/plugins/iCheck/custom.css" rel="stylesheet">-->

        <link href="../../css/animate.css" rel="stylesheet">
        <link href="../../css/plugins/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet">
        <link href="../../css/plugins/fullcalendar/fullcalendar.min.css" rel="stylesheet"/>
        <link href="../../css/style-ajax.css" rel="stylesheet">
        <style>
            /*自习*/

            .cus-ca-class0 {
                background-color: #777777 !important;
            }
            /*阶段*/

            .cus-ca-class1 {
                background-color: #00c0ef !important;
            }

            .cus-ca-class2 {
                background-color: #3c8dbc !important;
            }

            .cus-ca-class3 {
                background-color: #39cccc !important;
            }

            .cus-ca-class4 {
                background-color: #f39c12 !important;
            }

            .cus-ca-class5 {
                background-color: #f012be !important;
            }

            .cus-ca-class6 {
                background-color: #00a65a !important;
            }

            .cus-ca-class7 {
                background-color: #ff851b !important;
            }

            .cus-playerday-bg {
                background-color: #F8F8F8;
            }

            .cus-wanzixi-bg {
                opacity: 0.7;
            }

            .cus-label-xs,
            .js-label-xs-creat,
            .js-label-xs-addone,
            .js-label-xs-btnwd {
                font-weight: 400;
                font-size: 20px;
                cursor: pointer;
                color: #f8ac59;
                margin-right: 5px;
            }

            .tooltip-inner {
                text-align: left;
            }

            .js-week-btn-statue {
                position: absolute;
                left: 100%;
                top: 0;
            }

            #endclass_iconobj {
                font-size: 12px;
                color: #fff;
                background: #ed5565;
                padding: 3px 5px;
                vertical-align: top;
                border-radius: 3px;
            }

            .cus-shenhe-bg {
                background-image: url('images/calendar-cur-bg.png');
                background-repeat: no-repeat;
                background-position: 0 0;
            }

            .kuaijie-form-box button {
                margin: 0 8px 8px 0;
            }

            .table-condensed>tbody>tr>td,
            .table-condensed>tbody>tr>th,
            .table-condensed>tfoot>tr>td,
            .table-condensed>tfoot>tr>th,
            .table-condensed>thead>tr>td,
            .table-condensed>thead>tr>th {
                padding: 4px;
                line-height: 1.3;
            }
            /*170809-cj*/
           #calendar_win_child_box{min-height: 105px;}
           .cus-ts-btn{padding: 0px 3px;}
           .cus-ts-span{display: inline-block;padding-top: 1px;width: 20px;border: 1px solid #f90;border-radius: 10px;}
           .calendar-class-time{display: inline-block;margin-top: 4px;}
           .calendar-class-time .ts-inp{width: 98px !important;}
           .cus-alert-right{text-align: right; margin-bottom: 0;}
           .fc-cusBtnSave-button{background-color: #1ab394; color: #fff; border-color: #1ab394;}
           .cus-info{height: 27px; line-height: 27px; font-size: 12px; color: #999;}
           .cus-info .cus-info-color{display: inline-block; vertical-align: top; margin-top: 5.5px; width: 16px; height: 16px;}
           .cus-info>span{margin-right: 4px;}
           .cus-info .cus-wz{display: inline-block; margin-top: 2px;}
        </style>
    </head>

    <body>
        <div class="container">
            <div class="row space-15">
                <div class="col-sm-12">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>

        <!--新建整天-->
        <div class="event-calendar-win" id="calendar_win" style="display: none;">
            <div class="form p-sm">
                <div class="cus-form-box">
                    <div class="form-group">
                        <label>讲师</label>
                        <div class="input-group input-group-sm">
                            <input class="form-control" readonly="readonly" type="text" id="calendar_win_tea_val" />
                            <input class="form-control" type="hidden" id="calendar_win_tea_val_hide" />
                            <span class="input-group-btn">
                                <button class="btn btn-primary" type="button" id="calendar_win_tea_btn_1">
                                <i class="glyphicon glyphicon-search"></i>
                                </button>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>天数</label>
                        <input class="form-control input-sm" id="calendar_win_day_val" />
                    </div>
                    <div class="form-group">
                        <label>上课时段</label>
                        <div class="form-group pull-right">
                            <button id="add_class_time" class="btn cus-ts-btn btn-primary" type="button"><i class="glyphicon glyphicon-plus"></i></button>
                        </div>
                        <div class="form-inline" id="calendar_win_child_box">
                            <div class="calendar-class-time">
                                <div class="form-group">
                                    <select class="js-sel-day-time hidden form-control input-sm">
                                        <option value="-1">请选择</option>
                                        <option value="1">上午</option>
                                        <option value="2">下午</option>
                                        <option value="3">晚上</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>开始</label>
                                    <div class="input-group input-group-sm date">
                                        <select class="js-t-start ts-inp form-control input-sm"></select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>结束</label>
                                    <div class="input-group input-group-sm date">
                                        <select class="js-t-end ts-inp form-control input-sm"></select>
                                    </div>
                                </div>
                                <div class="js-re-class-time form-group" style="display: none;">
                                    <button class="btn cus-ts-btn btn-primary" type="button"><i class="glyphicon glyphicon-minus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>备注</label>
                        <input class="form-control input-sm" id="calendar_win_desc_val" />
                    </div>
                    <button class="btn btn-info btn-sm" onclick="creat_ca_event_fun(this)">创建</button>
                </div>
            </div>
        </div>
        <!--修改单条-->
        <div class="event-win-edit" id="jsevent_win_edit" style="display: none;">
            <div class="form p-sm">
                <div class="form-group">
                    <label>讲师</label>
                    <div class="input-group input-group-sm">
                        <input class="form-control" readonly="readonly" type="text" id="jsevent_win_tea_val" />
                        <input class="form-control" type="hidden" id="jsevent_win_tea_val_hide" />
                        <span class="input-group-btn">
                            <button class="btn btn-primary" type="button" id="jsevent_win_btn_1">
                            <i class="glyphicon glyphicon-search"></i>
                            </button>
                        </span>
                    </div>
                </div>
                <div class="form-group">
                    <label>上课时间</label>
                    <div class="input-group input-group-sm date" id="jsevent_win_date_box">
                        <input id="jsevent_win_date_val" type="text" name="name20" class="form-control input-sm" readonly="readonly" value="">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                    </div>
                    <div class="form-inline" id="event_dat_time">
                        <div class="calendar-class-time">
                            <div class="form-group">
                                <select class="js-sel-day-time form-control input-sm">
                                    <option value="-1">请选择</option>
                                    <option value="1">上午</option>
                                    <option value="2">下午</option>
                                    <option value="3">晚上</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>开始</label>
                                <div class="input-group input-group-sm date">
                                    <select class="js-t-start ts-inp form-control input-sm"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>结束</label>
                                <div class="input-group input-group-sm date">
                                    <select class="js-t-end ts-inp form-control input-sm"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea class="form-control" id="jsevent_win_desc_val"></textarea>
                </div>
                <button class="btn btn-info" onclick="edit_ca_event(this)">保存</button>
                <button class="btn btn-danger" onclick="del_ca_event_fun()">删除</button>
            </div>
        </div>

        <!-- Mainly scripts -->
        <script src="../../js/jquery-2.1.1.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script src="../../js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
        <script src="../../js/plugins/layer/layer.js"></script>

        <!-- Custom and plugin javascript -->
        <script src="../../js/jquery-ui.custom.min.js"></script>
        <script src="../../js/plugins/moment/moment.min.js"></script>
        <script src="../../js/plugins/fullcalendar/fullcalendar.min.js"></script>
        <script src="../../js/plugins/fullcalendar/zh-cn.js"></script>
        <script src="../../js/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>

        <script src="../../i18n/zh-CN.js"></script>
        <script src="../../js/subindex.js"></script>
        <!--<script src="../../js/plugins/iCheck/icheck.min.js"></script>-->
        <script src="../../js/plugins/fullcalendar/demo-calendar-3_1029.js"></script>

        <script>
            var CL_DEFAULE_CONFIG = {
                eClass: ['cus-ca-class3', 'cus-ca-class6', 'cus-ca-class1', 'cus-ca-class2', 'cus-ca-class4'],
                cType: { //班级类型key
                    d1: 1, //常规班
                    d2: 2 //寒暑假班
                }
            };
            var CCID_ = COM_TOOLS.requestParam('ccid') == 'row_3' ? 1 : 2; //演示使用
            /* 事件样式列表 */
            /**
             * CLASS_obj_ 阶段对象 json-object
            	cId:'a001', //班级ID
            	cName:'班级名称',
            	leverName:'阶段名称',
            	teaId:'t001', //讲师ID
            	teaName:'讲师姓名',
            	cType:1 //班级类型  1：年度班；2：短期班
             * */
            var CLASS_obj_ = {
                cId: 'a001',
                cName: '班级名称1',
                cTimeAll: 6, //总课时数，初始化数据时使用
                cStartDay: moment().startOf('month').format('YYYY-MM-DD'), //开课日期，初始化数据时使用 格式 '2019-08-01'
                ccName: '课程名称1',
                leverName: '阶段名称1',
                teaId: 't001',
                teaName: '讲师姓名1',
                cType: CCID_, //班级类型  1：年度班；2：短期班
                child: [ //课程，初始化数据时使用
                    {
                        eTime: 2, //时间 1：上午； 2：下午； 3：晚上
                        eStartTime: "09:00", // 开始时间
                        eEndTime: "10:30", //结束时间
                        ePoi: 1.5
                    },
                    /*{
                        eTime: 2, //时间 1：上午； 2：下午； 3：晚上
                        eStartTime: "14:00", // 开始时间
                        eEndTime: "16:00", //结束时间
                        ePoi: 2
                    }*/
                ]
            };
            /**
             * EVENTS_arr_ 事件源数据 json-object
             */
            var EVENTS_arr_ = [];
            var WEEKDAYS_ = []; //工作日
            var PLAYDAYS_ = []; //休息日
            var WEEKDAYS_PRIVATE_ = []; //当前系列班逻辑工作日
            function init_data_fun() { //第一次初始化数据
                if(CLASS_obj_.cTimeAll && CLASS_obj_.cTimeNum && CLASS_obj_.cStartDay && CLASS_obj_.child.length > 0) {
                    if(Math.ceil(CLASS_obj_.cTimeAll / CLASS_obj_.cTimeNum) !== CLASS_obj_.cTimeAll / CLASS_obj_.cTimeNum) {
                        COM_TOOLS.alert('元数据错误![error:001]'); //日总课时数必须能够被总课时数整除
                        return false;
                    }
                    var sday_ = CLASS_obj_.cStartDay,
                        daynum_ = Math.ceil(CLASS_obj_.cTimeAll / CLASS_obj_.cTimeNum);
                    calender_plu_tool.add_ca_event(sday_, CLASS_obj_['teaId'], CLASS_obj_['teaName'], daynum_, CLASS_obj_.cType, '', CLASS_obj_.child);
                } else {
                    COM_TOOLS.alert('元数据错误![error:002]');
                }
            }
            //初始化上课时段-ll
            function init_classData_fun() {
                var html_ = [];
                for(var i = 0, len = CLASS_obj_.child.length; i < len; i++) {
                    var itemId = CLASS_obj_.child[i]['eTime'],
                        itemN = 'g';
                    switch(itemId) {
                        case 1:
                            itemN = '上午';
                            break;
                        case 2:
                            itemN = '下午';
                            break;
                        case 3:
                            itemN = '晚上';
                            break;
                    }
                    html_.push('<label class="checkbox-inline">');
                    html_.push('<input type="checkbox" class="js-cchild" id="inlineCheckbox1" value="', itemId, '"> ', itemN);
                    html_.push('</label>');
                }
                $('#calendar_win_child_box').html(html_.join(''));
                calender_plu_tool.input_cChild = $('#calendar_win_child_box .js-cchild');
            }
            /* 获取初始化信息 */
            function getInitInfo(){
                ///k12crm-web/arrangeCourse/getSchedule
                $.getJSON('/k12crm-web/arrangeCourse/getSchedule', {cId: COM_TOOLS.requestParam('cId')}, function(d){
                    if(d.result == 1){
                        CLASS_obj_ = d.list;
                        EVENTS_arr_ = CLASS_obj_.cSchedule;
                        calendar = calendar_init_fun();
                        CLASS_obj_.cTimeNum = cus_FN_cj.sumTotaltime(CLASS_obj_.child);
                    }else{
                        COM_TOOLS.alert('初始化数据获取失败');
                    }
                    COM_TOOLS.loadingShade.close();
                });
            }
            //保存提交数据
            function saveScheduleInfo(){
                if(cus_FN_cj.sumTotaltime(EVENTS_arr_, 1) != CLASS_obj_.cTimeAll){
                    COM_TOOLS.alert('总课时数：'+ CLASS_obj_.cTimeAll +'，缺少课时：'+ (CLASS_obj_.cTimeAll - cus_FN_cj.sumTotaltime(EVENTS_arr_, 1)) +'，请补全。'); return false;
                }
                COM_TOOLS.loadingShade.open();
                var o_ = {};
                o_['cId'] = CLASS_obj_['cId'],
                o_['cSchedule'] = EVENTS_arr_;
                $.post('/k12crm-web/arrangeCourse/save', {'scheduleInfo': JSON.stringify(o_)}, function(res){
                    if(res.length > 0){
                        COM_TOOLS.alert('有'+ res.length + '条数据存在冲突！');
                        var conflict_List = [];
                        for(var i = 0, len = res.length; i < len; i++){
                            conflict_List.push(res[i].eId);
                        }
                        cus_FN_cj.judgmentConflict(conflict_List);
                    }else if(res.length == 0){
                        cus_FN_cj.deleteState('estate');
                        refetch_ca_draw();
                        COM_TOOLS.alert('提交成功！');
                    }else{
                        COM_TOOLS.alert('提交成功！');
                    }
                    COM_TOOLS.loadingShade.close();
                });
            }
            //讲师冲突校验
            function checkTeachAjax(evt, ajaxParam, callback){
                /*$(evt).attr('disabled', true);
                $.post('/k12crm-web/arrangeCourse/queryLecturerClash', ajaxParam, function(res){
                    if(res.index == 0){ //不冲突*/
                        callback && callback();
                    /*}else if(res.index == 1){
                        if(res.list.length){
                            var html_arr = [], list_ = res.list;
                            for(var i = 0, ilen = list_.length; i < ilen; i++){
                                html_arr.push('&nbsp;',list_[i]['cName'],'&nbsp;',list_[i]['dateClash'],'&nbsp;',(cus_FN_cj.checkTime(list_[i]['eTimeClash'])),'&nbsp;发生冲突<br>');
                            }
                            COM_TOOLS.alert('<p class="cus-alert-right">该讲师在'+ html_arr.join('') +'</p>', {shade: 0.01, time: 0, btn: ['知道了']});
                        }
                    }
                    $(evt).removeAttr('disabled');
                });*/
            }
            $(document).ready(function() {
                //COM_TOOLS.loadingShade.open();
                //getInitInfo();
                CLASS_obj_.cTimeNum = cus_FN_cj.sumTotaltime(CLASS_obj_.child, 1);
                EVENTS_arr_.length == 0 && init_data_fun();
                calendar = calendar_init_fun();
                /*单条记录*/
                $('#jsevent_win_btn_1').click(function() {
                    var pd_ = $(this).closest('#jsevent_win_edit').data('edata');
                    ///k12crm-web/kcrmuser/chooseUser?roleCode=JXJS-JXJL
                    cumParentWinModal('选择讲师', 'selectpage1.html', {
                        "area": ['600px', '430px'],
                        "callid": 'jsevent_win_tea_val'
                    });
                });
                /*全天记录*/
                $('#calendar_win_tea_btn_1').click(function() {
                    cumParentWinModal('选择讲师', 'selectpage1.html', {
                        "area": ['600px', '430px'],
                        "callid": "calendar_win_tea_val",
                        callback:{
                            fn2: function(obj) {
                                $('#calendar_win_tea_val').val(obj.name1)
                                $('#calendar_win_tea_val_hide').val(obj.DT_RowId)
                            }
                        }
                    });
                });
                cus_FN_cj.init_classData_fn();
            });
        </script>
    </body>

</html>

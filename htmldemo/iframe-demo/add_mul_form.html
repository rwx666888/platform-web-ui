<!doctype html>
<html>

    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <title>添加多个表单</title>

        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <!--<link href="../../font-awesome/css/font-awesome.css" rel="stylesheet">-->

        <link href="../../css/plugins/iCheck/custom.css" rel="stylesheet">

        <link href="../../css/plugins/select2/select2.min.css" rel="stylesheet">
        <link href="../../css/plugins/jsTree/style.min.css" rel="stylesheet">
        <link href="../../css/plugins/datetimepicker/bootstrap-datetimepicker.min.css" rel="stylesheet">
        <link href="../../css/animate.css" rel="stylesheet">
        <link href="../../css/style.css" rel="stylesheet">
        <link href="../../css/iconfont.css" rel="stylesheet"/>
        <style>
            #muban_box>.panel>.panel-body {
                position: relative;
            }
            
            #muban_box .close_remove {
                position: absolute;
                right: 5px;
                top: 5px;
                color: rgba(0, 0, 0, .5);
                font-size: 16px;
            }
            
            .panel-heading {
                padding: 5px 15px;
            }
        </style>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row" style="min-height: 50px;">
                <div class="p-sm col-xs-12 text-center" style="padding:10px;" id="demoaffix1" data-spy="affix" data-offset-top="50">
                    <button id="save_btn_form" class="btn btn-primary btn-sm" type="button">保存</button>
                    <button class="btn btn-success btn-sm" type="button" onclick="cumParentCallValue()">关闭</button>
                </div>

            </div>
        </div>

        <div class="container">
            <div class="row p-xxs">
                <div class="col-sm-12">
                    <div id="demo1" class="form-horizontal">
                        <div class="panel panel-default">
                            <div class="panel-heading">添加多个表单</div>
                            <form id="mul_form_box">
                                <div id="muban_box" class="panel-body "></div>
                            </form>
                            <div class="panel-footer" style="padding: 5px;">
                                <button id="add_muban" style="width:200px;" type="button" class="center-block btn-success btn-block  btn-sm btn">增加一条</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="muban" class="hidden">
            <div class="panel panel-default js-item">
                <div class="panel-body bg-success">
                    <span class="close_remove glyphicon glyphicon-remove"></span>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">文本框</label>
                        <div class="col-sm-3">
                            <input name="name1_{n}" class="form-control input-sm js-input" type="text" required></div>
                        <label class="col-sm-2 control-label">
                    <span class="text-danger">*</span>单选框
                </label>
                        <div class="col-sm-3">
                            <label class="checkbox-inline i-checks">
						<input name="name2_{n}" type="radio" value="radio1" class="js-input" required data-needjs="true"> 1
					</label>
                            <label class="checkbox-inline i-checks">
						<input name="name2_{n}" type="radio" value="radio2" class="js-input" data-needjs="true"> 2
					</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">
                    <span class="text-danger">*</span>select
                </label>
                        <div class="col-sm-3">
                            <select class="form-control input-sm js-input" name="name3_{n}" data-needjs="true">
                                <option value="">- 请选择-</option>
                                <option value="百度">百度</option>
                                <option value="谷歌">谷歌</option>
                                <option value="360">360</option>
                                <option value="搜狗">搜狗</option>
                                <option value="招聘网站">招聘网站</option>
                                <option value="分类信息">分类信息</option>
                                <option value="口碑">口碑</option>
                                <option value="招聘会">招聘会</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <label class="col-sm-2 control-label">
                            <span class="text-danger">*</span>复选框
                        </label>
                        <div class="col-sm-3">
                            <label class="radio-inline i-checks">
        						<input name="name4_{n}" type="checkbox" value="checkbox1" class="js-input" data-needjs="true"> 1
        					</label>
                            <label class="radio-inline i-checks">
        						<input name="name4_{n}" type="checkbox" value="checkbox2" class="js-input" data-needjs="true"> 2
        					</label>
                            <label class="radio-inline i-checks">
        						<input name="name4_{n}" type="checkbox" value="checkbox3" class="js-input" data-needjs="true"> 3
        					</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">文本框</label>
                        <div class="col-sm-3">
                            <div class="input-group input-group-sm">
                                <input type="text" name="name5_{n}" class="form-control input-sm js-helpmsg js-input" id="id1_{n}" required="required" readonly="readonly">
                                <input type="hidden" name="name6_{n}" id="id1_{n}_hide" class="js-input">
                                <span class="input-group-btn">
									<button class="btn btn-primary js-openwin-btn" data-title="数据窗口" data-url="selectpage1.html" 
									    data-options="area:['700px', '430px'], callback:{fn1:function(yourData){demoFn1('id1_{n}',yourData);}, fn2:function(yourData){demoFn2('id1_{n}',yourData);}}" type="button">
									<i class="glyphicon glyphicon-search"></i></button>
								</span>
                            </div>
                        </div>
                        <label class="col-sm-2 control-label">日历框</label>
                        <div class="col-sm-3">
                            <div class="input-group date" data-params="{'todayBtn': false}">
                                <input class="form-control input-sm js-input" type="text" name="name7_{n}" readonly/>
                                <span class="input-group-addon"><i class="tedufont tedu-icon130"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mainly scripts -->
        <script src="../../js/jquery-2.1.1.js"></script>
        <script src="../../js/bootstrap.min.js"></script>

        <script src="../../i18n/zh-CN.js" type="text/javascript"></script>
        <script src="../../js/plugins/layer/layer.js"></script>

        <script src="../../js/plugins/select2/select2.full.min.js"></script>
        <script src="../../js/plugins/jsTree/jstree.min.js"></script>
        <script src="../../js/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
        <script src="../../js/plugins/moment/moment.min.js"></script>
        <!-- Custom and plugin javascript -->
        <script src="../../js/plugins/validate/jquery.validate.custom.min.js"></script>
        <script src="../../js/subindex.js"></script>
        <script src="../../js/plugins/iCheck/icheck.min.js"></script>
        <script>
            function demoFn2(id, data) {
                $('#' + id).val(data.name1);
                $('#' + id + '_hide').val(data.DT_RowId);
            }

            function demoFn1(id, data) {
                $('#' + id).val('');
                $('#' + id + '_hide').val('');
            }
            $(function() {

                var item_index_ = 0;
                var clone_html_ = $('#muban').html();

                function add_item_fn(defDate) {
                    var o_ = $(clone_html_.replace(new RegExp(/(_{n})/g), '_' + item_index_));
                    $('#muban_box').append(o_);
                    init_elm_js_fn(o_, defDate);
                    item_index_++;
                }

                function check_form_fn() {
                    $('#mul_form_box').submit();
                }

                function init_icheck_fn(obj) {
                    obj.iCheck({
                        checkboxClass: 'icheckbox_square-green',
                        radioClass: 'iradio_square-green',
                    });
                }

                function init_select2_fn(obj) {
                    obj.select2();
                }
                function init_datetimepicker_fn(obj,opt){
                    obj.datetimepicker(COM_TOOLS.parseOjects(opt));
                }

                function get_elm_type(obj) {
                    var nodeName_ = obj.prop('nodeName').toLowerCase();
                    if(nodeName_ && nodeName_ == 'select') {
                        return 'select';
                    } else if(nodeName_ && nodeName_ == 'input') {
                        var type_ = obj.attr('type').toLowerCase();
                        if($.inArray(type_, ['text', 'radio', 'checkbox']) !== -1) {
                            return type_;
                        }
                    }
                    return '';
                }

                function init_elm_js_fn(obj, defDate) {
                    obj.find('.js-input').each(function() {
                        var this_ = $(this),
                            type_ = get_elm_type(this_),
                            needjs_ = this_.data('needjs') || false,
                            eName_ = this_.attr('name').split('_')[0],
                            eValue_ = '';
                        if(defDate) {
                            eValue_ = $.type(defDate[eName_]) != "undefined" ? defDate[eName_] : '';
                        }
                        if(type_) {
                            if($.inArray(type_, ['radio', 'checkbox']) !== -1) {
                                if(eValue_) {
                                    $.inArray(this_.val(), eValue_.split(',')) !== -1 && this_.prop('checked', true);
                                }
                                needjs_ && init_icheck_fn(this_);
                            } else if(type_ == 'select') {
                                if(eValue_) {
                                    this_.val(eValue_);
                                }
                                needjs_ && init_select2_fn(this_);
                            } else if(type_ == 'text') {
                                if(eValue_) {
                                    this_.val(eValue_);
                                }
                                var parent_obj=this_.parent();
                                if(parent_obj.hasClass("date")){
                                	init_datetimepicker_fn(parent_obj,parent_obj.attr("data-params"));
                                }
                            }
                        } else {
                            if(eValue_) {
                                this_.val(eValue_);
                            }
                        }
                    });
                }

                function get_obj_data(d) {
                    var o = {},
                        f_ = $(d).serializeArray();
                    $.each(f_, function(i, n) {
                        var name_ = n['name'].split('_')[0];
                        if(o[name_]) {
                            o[name_] = o[name_] + "," + n['value'];
                        } else {
                            o[name_] = n['value'];
                        }
                    });
                    return o;
                }

                function get_listdata() {
                    var data_ = [];
                    $('#muban_box .js-item').each(function() {
                        data_.push(get_obj_data($(this).find('.js-input')));
                    });
                    return data_;
                }

                function form_submit_fn() { //保存提交数据
                    var data = get_listdata();
                    //ajax data
                    alert(JSON.stringify(data));
                }
                $('#muban_box').on('click', '.close_remove', function() {
                    $(this).closest('.js-item').remove();
                });
                var fn_do = add_item_fn;
                $('#add_muban').click(function() {
                    fn_do = add_item_fn;
                    check_form_fn();
                });
                $('#mul_form_box').validate({
                    submitHandler: function(form) {
                        fn_do();
                    }
                });
                $('#save_btn_form').click(function() {
                    fn_do = form_submit_fn;
                    check_form_fn();
                });
                $('#muban_box').on('click', '.js-openwin-btn', function() {
                    var this_ = $(this),
                        d_ = this_.data(),
                        opt_ = {};
                    if(d_['options']) {
                        opt_ = COM_TOOLS.parseOjects(d_['options']);
                    }
                    console.log(opt_);
                    cumParentWinModal(d_['title'], d_['url'], opt_);
                });

                /* 
                 * 初始化回显数据源 
                 * 数组有数据则为修改模式，数组为null，则为新建模式
                 */
                var init_data = [{
                        "name1": "1",
                        "name2": "radio2",
                        "name3": "谷歌",
                        "name4": "checkbox1,checkbox3",
                        "name5": "data_01",
                        "name7":"2018-1-1"
                    },
                    {
                        "name1": "2",
                        "name2": "radio1",
                        "name3": "360",
                        "name4": "checkbox2",
                        "name5": "data_02",
                        "name7":"2018-1-2"
                    }
                ];
                if(init_data && init_data.length > 0) { //修改回显
                    $.each(init_data, function(i, n) {
                        add_item_fn(n);
                    });
                } else { //新增
                    $('#add_muban').trigger('click');
                }
            });
        </script>
    </body>

</html>
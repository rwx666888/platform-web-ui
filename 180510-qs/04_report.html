<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
    <title>趋势分析-三年对比</title>
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link href="../css/plugins/dataTables/datatables.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .row {
            margin: 0 -10px
        }

        .col-sm-4,
        .col-sm-6,
        .col-sm-12 {
            padding: 0 10px;
        }

        .tab-content {
            padding: 10px;
            border: 1px solid #ddd;
            border-top: none;
            border-bottom-left-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        .tab-content .panel {
            margin-bottom: 0;
        }

        .table {
            font-size: 12px;
        }

        .dataTables_wrapper {
            padding-bottom: 0;
        }

        .panel-heading,
        .panel-body {
            padding: 10px;
        }

        .cus-group-area {
            margin-top: 10px;
        }

        .cus-echarts {
            width: 100%;
            height: 350px;
            margin-bottom: 20px;
            border-bottom: 2px solid #337ab7;
            padding-bottom: 10px;
        }

        .cus-echarts:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        /* 180702-cj 搜索栏 提示框 */

        .cus-search-area {
            margin-top: 10px;
            min-height: 44.5px;
        }

        .cus-search-area .cus-search-bar {
            padding: 6px;
            border: 1px solid #dddddd;
        }

        .cus-search-bar {
            position: fixed;
            top: 10px;
            left: 15px;
            z-index: 99;
            background-color: #f6f6f6;
            border-radius: 5px;
        }

        .md180702cj-custips {
            margin-top: 3px;
            cursor: pointer;
        }

        .md180702cj-custips+.tooltip.in {
            opacity: 1;
        }

        .md180702cj-custips+.tooltip .tooltip-arrow {
            border-left-color: #ccc;
        }

        .md180702cj-custips+.tooltip .tooltip-inner {
            max-width: none;
            background-color: #ccc;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 搜索 -->
            <div class="col-sm-12 m-b-sm cus-search-area">
                <div class="form-inline cus-search-bar">
                    <div class="form-group form-group-sm">
                        <label>年份：</label>
                        <select id="js_year" class="form-control input-sm">
                            <option value="2018">2018</option>
                        </select>
                    </div>
                    <div class="form-group form-group-sm">
                        <label>月份：</label>
                        <select id="js_month" class="form-control input-sm">
                            <option value="10">10</option>
                        </select>
                    </div>
                    <button id="js_btn_sreach" class="btn btn-sm btn-success" type="button">搜索</button>
                </div>
            </div>
        </div>
        <div class="cus-group-area">
            <div class="row">
                <div class="col-sm-12">
                    <!-- <h2>四、运营指标：趋势分析-三年对比</h2> -->
                    <h3>1、运营结果指标-趋势分析-三年对比</h3>
                </div>
            </div>
            <div class="row">
                <!-- 分组 -->
                <div class="col-sm-12">
                    <!-- 图表01 -->
                    <div class="panel panel-success">
                        <div class="panel-heading">权责销售收入-趋势分析-三年对比</div>
                        <div class="panel-body js-cus-group">
                            <!-- 切换 -->
                            <div>
                                <label> 请选择区域：</label>
                                <select class="js-select-area">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                </select>
                                <span class="pull-right">单位：万元</span>
                            </div>
                            <!-- 数据图 -->
                            <div id="d_eacharts_01" class="js-getApi-ec cus-echarts"></div>
                        </div>
                    </div>
                    <!-- 图表01 end -->
                </div>
                <!-- 分组 end -->
                <!-- 分组 -->
                <div class="col-sm-12">
                    <!-- 图表01 -->
                    <div class="panel panel-success">
                        <div class="panel-heading">集团销售利润-趋势分析-三年对比</div>
                        <div class="panel-body js-cus-group">
                            <!-- 切换 -->
                            <div>
                                <label> 请选择区域：</label>
                                <select class="js-select-area">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                </select>
                                <span class="pull-right">单位：万元</span>
                            </div>
                            <!-- 数据图 -->
                            <div id="d_eacharts_02" class="js-getApi-ec cus-echarts"></div>
                        </div>
                    </div>
                    <!-- 图表01 end -->
                </div>
                <!-- 分组 end -->
            </div>
        </div>
    </div>
    <script src="../js/jquery-2.1.1.js" type="text/javascript"></script>
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../js/plugins/echarts/echarts.js"></script>
    <script src="../js/plugins/jquery-number/jquery.number.min.js"></script>
    <script src="../i18n/zh-CN.js" type="text/javascript"></script>
    <script src="../js/subindex.js" type="text/javascript"></script>
    <script src="../js/jquery.mockjax.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var s_data = [{
            cname: "p1",
            data: [
                { name: "name1", value: 10000000 },
                { name: "name2", value: 225 },
                { name: "name3", value: 2011 },
                { name: "name4", value: 900 },
                { name: "name5", value: 750 },
                { name: "name6", value: 759 },
                { name: "name7", value: 919 },
                { name: "name8", value: null }, // 注意这里的，不能少
                { name: "name9", value: null },
                { name: "name10", value: null },
                { name: "name11", value: null },
                { name: "name12", value: null }
            ]
        },
        {
            cname: "p2",
            data: [
                { name: "name1", value: -944 },
                { name: "name2", value: 211 },
                { name: "name3", value: 374 },
                { name: "name4", value: 519 },
                { name: "name5", value: 487 },
                { name: "name6", value: 455 },
                { name: "name7", value: 643 },
                { name: "name8", value: 652 },
                { name: "name9", value: 532 },
                { name: "name10", value: 587 },
                { name: "name11", value: 675 },
                { name: "name12", value: 612 }
            ]
        }, {
            cname: "p3",
            data: [
                { name: "name1", value: 611 },
                { name: "name2", value: 91 },
                { name: "name3", value: -81 },
                { name: "name4", value: 480 },
                { name: "name5", value: 439 },
                { name: "name6", value: 347 },
                { name: "name7", value: 499 },
                { name: "name8", value: 411 },
                { name: "name9", value: 465 },
                { name: "name10", value: 337 },
                { name: "name11", value: 355 },
                { name: "name12", value: 375 }
            ]
        }
        ];
        $.mockjax({
            url: "/ec/api",
            dataType: "json",
            response: function (settings) {
                this.responseText = s_data;
            }
        });
    </script>
    <script type="text/javascript">
        $(function () {
            var PRO_TOOLS = {
                //减    
                floatSub: function (arg1, arg2) {
                    if (arg1 != null && arg2 != null) {
                        var r1, r2, m, n;
                        try { r1 = arg1.toString().split(".")[1].length; } catch (e) { r1 = 0; }
                        try { r2 = arg2.toString().split(".")[1].length; } catch (e) { r2 = 0; }
                        m = Math.pow(10, Math.max(r1, r2));
                        //动态控制精度长度    
                        n = (r1 >= r2) ? r1 : r2;
                        return ((arg1 * m - arg2 * m) / m).toFixed(n);
                    } else {
                        return '-';
                    }
                },
                // 除法
                floatDiv: function (arg1, arg2) {
                    if (arg1 != null && arg2 != null) {
                        var t1 = 0,
                            t2 = 0,
                            r1, r2;
                        try { t1 = arg1.toString().split(".")[1].length; } catch (e) { }
                        try { t2 = arg2.toString().split(".")[1].length; } catch (e) { }
                        r1 = Number(arg1.toString().replace(".", ""));
                        r2 = Number(arg2.toString().replace(".", ""));
                        return (r1 / r2) * Math.pow(10, t2 - t1);
                    } else {
                        return '-';
                    }
                },
                // 乘    
                floatMul: function (arg1, arg2) {
                    // console.log(arg1, arg2);

                    if (arg1 != null && arg2 != null) {
                        var m = 0,
                            s1 = arg1.toString(),
                            s2 = arg2.toString();
                        try { m += s1.split(".")[1].length; } catch (e) { }
                        try { m += s2.split(".")[1].length; } catch (e) { }
                        return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
                    } else {
                        return '-';
                    }
                },
                // type 显示类型 0-默认，整数， 1-百分比
                changeNum: function (row, name1, name2, type, dec) {
                    var res_ = '';
                    if (row.type != 2) {
                        res_ = this.floatSub(row[name1], row[name2]);
                        if (res_ > 0) {
                            res_ = (type ? '<span class="text-info">+' + (this.dataProcess(this.floatMul(res_, 100), dec || 0) + '%') + '</span>' : '<span class="text-info">+' + this.cusNumber(res_, dec) + '</span>');
                        } else if (res_ < 0) {
                            res_ = (type ? '<span class="text-danger">-' + (this.dataProcess(this.floatMul(Math.abs(res_), 100), dec || 0) + '%') + '</span>' : '<span class="text-danger">-' + this.cusNumber(Math.abs(res_), dec) + '</span>');
                        } else {
                            res_ = '-';
                        }
                    }
                    return res_;
                },
                dataFilter: function (data, row) {
                    var res_ = data;
                    if (row.type == 2) {
                        res_ = '';
                    }
                    return res_;
                },
                dataProcess: function (s_data, dec) {
                    var num;
                    if (s_data != null) {
                        num = Number(s_data);
                        if (num || num == 0) {
                            if (Math.abs(num) > 1) {
                                num = dec >= 0 ? num.toFixed(dec) : num;
                            } else {
                                num = num;
                            }
                        } else {
                            num = s_data;
                        }
                    } else {
                        num = '-';
                    }
                    return num;
                },
                cusNumber: function (s_data, dec) {
                    if (s_data != null) {
                        s_data = ($.number && $.number(s_data, dec || 0)) || s_data;
                    } else {
                        s_data = '-';
                    }
                    return s_data;
                },
                sp_dataShow: function (ele, s_arr) {
                    var $ele = $('#' + ele).closest('.js-data-show');
                    var t_data = $.grep(s_arr, function (n, i) {
                        return n.type == 3;
                    })[0];
                    if (!$.isEmptyObject(t_data)) {
                        $ele.find('.js-money').text($.number(t_data.number));
                        $ele.find('.js-complete-rate').text(PRO_TOOLS.floatMul(t_data.t_rate, 100) + '%');
                        $ele.find('.js-increase-rate').text(PRO_TOOLS.floatMul(t_data.n_increaserate, 100) + '%');
                    }
                }
            };

            /**
             * 自定义图标初始化
             * @param  {[string]} ele    [jq对象]
             * @param  {[strgin]} a_url  [接口地址]
             * @param  {[object]} a_data [接口参数]
             * @param  {[type]} fopt   [图表 数据组配置]
             * @param  {[type]} dopt   [数据项配置]
             * @param  {[type]} opt    [图表 配置]
             */
            function cusIniteCharts(ele, a_url, a_data, fopt, dopt, opt) {
                var s_data, etype, efopt, edopt, ebaeOpt;

                //数据组配置
                efopt = $.extend(true, {
                    "p1": {
                        name: '2017',
                        type: 'line',
                        itemStyle: { normal: { label: { show: false } } } //默认显示数据数值
                    },
                    "p2": {
                        name: '2016',
                        type: 'line',
                        itemStyle: { normal: { label: { show: false } } } //默认显示数据数值
                    },
                    "p3": {
                        name: '2015',
                        type: 'line',
                        itemStyle: { normal: { label: { show: false } } } //默认显示数据数值
                    }
                }, (fopt || {}));
                //数据项配置
                edopt = $.extend(true, {
                    name1: '1月',
                    name2: '2月',
                    name3: '3月',
                    name4: '4月',
                    name5: '5月',
                    name6: '6月',
                    name7: '7月',
                    name8: '8月',
                    name9: '9月',
                    name10: '10月',
                    name11: '11月',
                    name12: '12月'
                }, (dopt || {}));
                // echarts 配置
                ebaeOpt = $.extend(true, {
                    title: {
                        text: ''
                    },
                    grid: {
                        //top: '5%',
                        // bottom: '5%',
                        //left: '7%',
                        right: '5%',
                        //containLabel: true, // 防止标签溢出
                        //x: 10, //x/y/x2/y2 分别控制图标距离父元素边缘距离
                        //y: 30
                    },
                    tooltip: {
                        formatter: function (params, ticket, callback) {
                            var arr_ = [];
                            arr_.push(params[0].name + '<br/>');
                            for (let idx = 0; idx < params.length; idx++) {
                                const el = params[idx];
                                console.log();

                                arr_.push(el.marker + el.seriesName + '：' + (PRO_TOOLS.cusNumber(el.value)) + '<br/>');
                            }
                            return arr_.join('');
                        }
                    },
                    xAxis: {
                        axisLabel: {
                            formatter: function (val) { //纵向显示x轴文字
                                //return val.split("").join("\n");
                                return val;
                            }
                        },
                        //boundaryGap: true
                    },
                    yAxis: {
                        min: 'dataMin'
                        // min: function (val) { 
                        //     return val.min - 100;
                        // }
                        // boundaryGap: ['20%', '20%']
                        //boundaryGap: true
                    }
                }, (opt || {}));

                var c_echarts = COM_TOOLS.eChartsTools.initOpt(ele, 'line', [], efopt, edopt, ebaeOpt);
                $(ele).data({'plugin_api': c_echarts, 'ajax_data': a_data});

                // 发生请求
                c_echarts.showLoading();
                $.ajax({
                    url: a_url,
                    type: 'POST',
                    dataType: 'json',
                    data: a_data,
                })
                .done(function (res) {
                    //s_data = res;
                    COM_TOOLS.eChartsTools.updateData(ele, res);
                })
                .fail(function () {
                    console.log("error");
                })
                .always(function () {
                    c_echarts.hideLoading();
                });
                // console.log(c_echarts);
                
                return c_echarts;
            }

            // 初始化图表 变量名 要与 id 同名
            cusIniteCharts('#d_eacharts_01', '/ec/api', { id: 1 });
            cusIniteCharts('#d_eacharts_02', '/ec/api', { id: 1 });

            // 区域选择
            $('.js-select-area').change(function (evt) {
                var v_ = $(this).val();
                var ele = $(this).closest('.js-cus-group').find('.js-getApi-ec');
                var ele_id = ele.attr('id');
                var ele_api = ele.data('plugin_api');
                
                ele_api.showLoading(); // 注意 eval
                $.ajax({
                    url: '/ec/api',
                    type: 'POST',
                    dataType: 'json',
                    data: { id: v_ },
                })
                .done(function (res) {
                    COM_TOOLS.eChartsTools.updateData('#' + ele_id, res);
                })
                .fail(function () {
                    console.log("error");
                })
                .always(function () {
                    console.log("complete");
                    ele_api.hideLoading();
                });
            });
            // 搜索栏
            $('#js_btn_sreach').click(function() {
                var searchObj = {
                    'b_year': $('#js_year').val(),
                    'b_month': $('#js_month').val()
                }
                $('.js-getApi-ec').each(function(idx, val) {
                    var t_ = $(val);
                    if(t_.is('[id]')){
                        // console.log(t_);
                        var t_id = t_.attr('id');
                        var t_api = t_.data('plugin_api');
                        var t_data = t_.data('ajax_data');
                        var new_search = $.extend({}, t_data, searchObj);
                        // console.log(t_, t_api, t_data, new_search);
                        
                        // t_api.setAjaxData(new_search);
                        t_api.showLoading(); // 注意 eval
                        $.ajax({
                            url: '/ec/api',
                            type: 'POST',
                            dataType: 'json',
                            data: new_search,
                        })
                        .done(function (res) {
                            COM_TOOLS.eChartsTools.updateData('#' + t_id, res);
                        })
                        .fail(function () {
                            console.log("error");
                        })
                        .always(function () {
                            console.log("complete");
                            t_api.hideLoading();
                        });
                    }
                });
                // 特殊的可以单独通过 id 获取来修改
            });

        });
    </script>
</body>

</html>